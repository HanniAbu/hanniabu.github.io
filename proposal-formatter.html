<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1" name="viewport">
    <title>Proposal Formatter | Hanni Abu</title>
    <meta content="Easily output proper format for Blocknet newsletters." name="description">
    <meta content="proposal, blocknet, superblock, format" name="keywords">
    <meta content="Hanni Abu" name="author">
    <meta content="Â© 2015, Hanni Abu. All rights reserved." name="copyright">
    <meta content="index,follow" name="robots">
    <link href="assets/img/logo.gif" rel="icon" type="image/gif">
    <link href="assets/css/style.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Lato:100,300,400,700,900" rel="stylesheet" type="text/css">
    <meta content="en_us">
    <meta content="Hanni Abu">
    <meta content="website">
    <meta content="index.html">
    <meta content="assets/img/logo.gif">
    <meta content="Easily output proper format for Blocknet newsletters.">
    <meta content="index.html" name="twitter:url">
    <meta content="Proposal Formatter | Hanni Abu" name="twitter:title">
    <meta content="Easily output proper format for Blocknet newsletters." name="twitter:description">
    <meta content="assets/img/logo.gif" name="twitter:image">
    
    <script async="" src="//www.google-analytics.com/analytics.js"></script><script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-63358219-1', 'auto'); ga('send', 'pageview'); 
    </script>
  </head>
  <body>
    <style type="text/css">
      body {
        width: 100vw;
        max-width: 500px;
        margin: 0 auto;
        margin-bottom: 40px;
        position: relative;
        padding: 20px;
      }
      input, input:focus, input:hover, input:active {
        /*remove style*/
        appearance: none !important;
        outline: none !important;
        outline: 0 !important;
        border-style: none !important;
        border-color: none !important;
        box-shadow: none !important;
        /*add style*/
        background-color: rgba(255,255,255,0.65);
        color: #555;
        text-align: center;
        border-radius: 5px;
        padding: 5px;
        font-size: .9em;
      }
      code {
        background-color: #eee;
        color: maroon;
        font-family: monospace;
      }
      textarea {
        overflow: auto;
        width: 100%
      }
      select {
        width: 150px;
        padding: 5px 10px;
      }
      p {
        font-weight: bold;
      }

    </style>


    <p>1. Paste <code>listproposals</code> output here:</p>
    <textarea id="raw" rows="15" cols="75" oninput="runApp()" onchange="runApp()"></textarea>
    <p>2. Select Superblock period:</p>
    <select id="superblocks" onselect="format()"></select>
    <p>3. Copy formatted summary
      <button onclick="CopyToClipboard('formatted')">
        <span style="font-size: .875em; margin-right: .125em; position: relative; top: -.25em; left: -.125em">ðŸ“„<span style="position: absolute; top: .25em; left: .25em">ðŸ“„</span></span>
      </button>
    </p>
    <div id="formatted"></div>


    <script type="text/javascript">
      var dev = true;
      var proposals;
      function logError(error) {
        console.log('Fetch Error: ', error.message);
      }
      function log(msg) {
        if (dev) { console.log(msg); }
      }
      function processResult(result) {
        var data = result[0]["Voting"]["Finalized"];
        var superblockKeysArray = Object.keys(data);
        var output = "";
        for (var superblockKeyIndex in superblockKeysArray) {
          var superblockNumber = superblockKeysArray[superblockKeyIndex];
          var proposalGroupKeyArray = Object.keys(data[superblockNumber]);
          log(data[superblockNumber]);
          log(superblockNumber);
          output = "<br><strong>" + superblockNumber + "</strong><br>";
          for (var proposalGroupKeyIndex in proposalGroupKeyArray) {
            var proposalGroup = proposalGroupKeyArray[proposalGroupKeyIndex];
            var proposalKeyArray = Object.keys(data[superblockNumber][proposalGroup]);
            log(data[superblockNumber][proposalGroup]);
            log("\t"+proposalGroup);
            for (var proposalKeyIndex in proposalKeyArray) {
              var proposalName = proposalKeyArray[proposalKeyIndex];
              var proposalData = data[superblockNumber][proposalGroup][proposalName];
              log("\t\t"+proposalName);
              var name = proposalData["name"];
              var status = "Failed";
              var payment = proposalData["totalpayment"];
              var yayVotes = proposalData["votingyeas"];
              var nayVotes = proposalData["votingnays"];
              var netVotes = yayVotes - nayVotes;
              var snodes = proposalData["active_nodes"];
              if (netVotes > Math.ceil(snodes/10)) {
                status = "Passed";
              }
              if (proposalGroupKeyIndex == 0 && proposalKeyIndex == 0) {
                var summary = "For Superblock " + superblockNumber + " there was a total of " + snodes + " Service Nodes, requiring a net of at least " + Math.ceil(snodes/10) + " votes for a proposal to pass. The results are as follows:<br>"
                output = output + summary;
              }
              // [name] - [passed/failed]: [payment] BLOCK [yay]-[nay], Net [yay-nay]
              var formattedResult = name + " - " + status + ": " + payment + " BLOCK " + yayVotes + "-" + nayVotes + ", Net " + netVotes;
              // output = output + formattedResult + "\n";
              output = output + formattedResult + "<br>";
            }
          }
          log("\n");
        }
        document.getElementById("content").innerHTML = output;
      }
      function saveResult(result) {
        localStorage.setItem("info", JSON.stringify(result));
        return result;
      }
      function logResult(result) {
        log(result);
        return result;
      }
      function readResponseAsJSON(response) {
        return response.json();
      }
      function validateResponse(response) {
        if (!response.ok) {
          throw Error(response.statusText);
        }
        return response;
      }
      function fetchJSON(pathToResource) {
        fetch(pathToResource)
        .then(validateResponse)
        .then(readResponseAsJSON)
        // .then(saveResult)
        .then(logResult)
        .then(processResult)
        .catch(logError);
      }
      function runApp() {
        // fetchJSON('https://cors-anywhere.herokuapp.com/https://api.block-node.info/getLastVoting.php');

        var raw = document.getElementById("raw").value;
        proposals = JSON.parse( "[" + raw.split("[")[1] );
        populateDropdown();
      }
      function populateDropdown() {
        var superblockPeriods = [];
        for (var proposal in proposals) {
          if ( !superblockPeriods.includes(proposals[proposal]["superblock"]) ) {
            superblockPeriods.push( proposals[proposal]["superblock"] );
          }
        }
        var superblockDrowdown = document.getElementById("superblocks");
        for (var superblock in superblockPeriods) {
          var option = document.createElement("option");
          option.text = superblockPeriods[superblock];
          option.value = superblockPeriods[superblock];
          superblockDrowdown.add(option);
        }
        format();
      }
      function format() {
        var dropdown = document.getElementById("superblocks");
        var superblock = dropdown.options[dropdown.selectedIndex].value;
        var summary = [];
        for (var proposal in proposals) {
          if ( proposals[proposal]["superblock"] == superblock ) {
            var p = proposals[proposal];
            var formatted = p["name"] + ", " + p["amount"] + " BLOCK, Y:" + p["votes_yes"] + " | N:" + p["votes_no"] + " | A:" + p["votes_abstain"] + ", " + p["status"][0].toUpperCase() + p["status"].slice(1);
            summary.push(formatted);
          }
        }
        summary.sort(function (a, b) {
          return a.toLowerCase().localeCompare(b.toLowerCase());
        });
        document.getElementById("formatted").innerHTML = summary.join("<br>");
      }
      function CopyToClipboard(containerid) {
        var e = document.getElementById(containerid);
        // for Internet Explorer
        if(document.body.createTextRange) {
          var range = document.body.createTextRange();
          range.moveToElementText(e);
          range.select();
          document.execCommand("Copy");
        }
        else if(window.getSelection) {
          // other browsers
          var selection = window.getSelection();
          var range = document.createRange();
          range.selectNodeContents(e);
          selection.removeAllRanges();
          selection.addRange(range);
          document.execCommand("Copy");
        }
      }
      // runApp();
    </script>
  </body>
</html>
