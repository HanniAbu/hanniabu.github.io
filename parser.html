<html>
  <head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1" name="viewport">
    <title>Log Viewer | Hanni Abu</title>
    <meta content="Easily view log contents." name="description">
    <meta content="log, file, view" name="keywords">
    <meta content="Hanni Abu" name="author">
    <meta content="Â© 2015, Hanni Abu. All rights reserved." name="copyright">
    <meta content="index,follow" name="robots">
    <link href="assets/img/logo.gif" rel="icon" type="image/gif">
    <link href="assets/css/style.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Lato:100,300,400,700,900" rel="stylesheet" type="text/css">
    <meta content="en_us">
    <meta content="Hanni Abu">
    <meta content="website">
    <meta content="index.html">
    <meta content="assets/img/logo.gif">
    <meta content="Easily view log contents.">
    <meta content="index.html" name="twitter:url">
    <meta content="Log Viewer | Hanni Abu" name="twitter:title">
    <meta content="Easily view log contents." name="twitter:description">
    <meta content="assets/img/logo.gif" name="twitter:image">
    
    <script async="" src="//www.google-analytics.com/analytics.js"></script><script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-63358219-1', 'auto'); ga('send', 'pageview'); 
    </script>

  </head>
  <body>
    <style type="text/css">
      body {
        padding-left: 50px;
      }
    </style>


    <script type="text/javascript">
      var rawLog;
      var indent = "&nbsp;&nbsp;&nbsp;&nbsp;";
      var dindent = indent + indent;
      var currentEpoch = Date.now(); // milliseconds
      // log format
        // [
        //   {
        //     uuid: string
        //     fname: string
        //     lname: string
        //     username: string
        //     query: string
        //     timestamp: epoch int
        //   },
        //   ...
        // ]


      getLogAjax().then(processLog).then(showSummary);
      function getLogAjax() {
        var promise = new Promise(function(resolve, reject){
          var alert = "Failed to load log, refresh page";
          var xhr = new XMLHttpRequest();
          var status = true;
          xhr.timeout = 2000;  
          xhr.addEventListener("timeout", function(e) {
            alert(alert);
          });
          var url = "http://45.79.148.58:3000/shrewdly-ferocity-trough";
          xhr.open('GET', url);
          xhr.send();
          xhr.onreadystatechange = function(){
            if (xhr.readyState === 4) {
              if (xhr.status === 200){
                var response = this.responseText;
                // var processedData = "[" + response.split("}{").join("},{") + "]";
                // log = JSON.parse(processedData);
                resolve(response);
              } else {
                alert(alert);
              }
            }
          }
        });
        return promise;
      }
      function processLog(rawLog) {
        var jsonLog = convertToJson(rawLog);
        var adjustedLog = addUsernames(jsonLog);
        var cleanedLog = cleanLog(adjustedLog);
        return cleanedLog;
      }
      function convertToJson(rawLog) {
        // convert string log to json
        return JSON.parse("[" + rawLog.split("}{").join("},{") + "]");
      }
      function addUsernames(jsonLog) {
        // add username if not present, suffixed with ***
        var adjustedLog = jsonLog;
        for (var user in adjustedLog) {
          var username = adjustedLog[user]["username"];
          if (username === undefined) {
            var fname = adjustedLog[user]["fname"];
            var lname = adjustedLog[user]["lname"] ? adjustedLog[user]["lname"] : "";
            adjustedLog[user]["username"] = fname + lname + "***";
          } 
        }
        return adjustedLog;
      }
      function cleanLog(adjustedLog) {
        // remove in-progress searches
        var cleanedLog = [];
        var users = getUniqueUsers(adjustedLog);
        var bufferTime = 4000; // milliseconds
        var times = [];
        for (var user in users) {
          var requests = getUserRequests(adjustedLog, users[user]);
          var r0 = requests[0];
          for (var request in requests) {
            if (r0 == requests[0] && requests.length == 1) {
              cleanedLog.push(r0);
            } else if (r0 != undefined && r0 != requests[request]) {
              var rf = requests[request];
              var timeDiff = rf["timestamp"] - r0["timestamp"];
              var includes = rf["query"].startsWith(r0["query"]);
              var repeat = includes && r0["query"] != "";
              // if not a repeat request, save the previous request
              if (!repeat) {
                cleanedLog.push(r0);
              }
              // if last request, save, otherwise set rf to r0 to reset
              if (request == requests.length - 1) {
                cleanedLog.push(rf);
              } else {
                r0 = rf;
              }
            }
          }
        }
        return cleanedLog;
      }
      function showSummary(log) {
        var summary = generateSummary(log);
        document.body.innerHTML = summary;
      }
      function getTotalRequests(log) {
        return log.length;
        // output:
        // int
      }
      function getUniqueUsers(log) {
        var users = [];
        for (var entry in log) {
          var username = log[entry]["username"];
          if ( !users.includes(username) ) {
            users.push(username);
          }
        }
        return users;
        // output:
        // [ "usernameA", "usernameB", "usernameN" ]
      }
      function getTotalUsers(log) {
        var users = getUniqueUsers(log);
        return users.length;
        // output:
        // int
      }
      function getAveRequestsPerUser(log) {
        var totalRequests = getTotalRequests(log);
        var totalUsers = getTotalUsers(log);
        return Math.round( (totalRequests/totalUsers)*10 ) / 10;
        // output:
        // int
      }
      function getTotalRequestsPerUser(log) {
        var users = getUniqueUsers(log);
        var requestsPerUser = [];
        for (var user in users) {
          requestsPerUser.push({ "username": users[user], "totalRequests": getUserRequestCount(log, users[user]) });
        }
        // sort user metrics by total requests
        requestsPerUser.sort(function(a, b) {
          var keyA = new Date(a.totalRequests);
          var keyB = new Date(b.totalRequests);
          if (keyA < keyB) return 1;
          if (keyA > keyB) return -1;
          return 0;
        });
        return requestsPerUser;
        // output:
        // [
        //   {
        //     username: "usernameA",
        //     totalRequests: int
        //   },
        //   ...
        // ]
      }
      function getUserRequests(log, user) {
        var requests = [];
        for (var entry in log) {
          if (log[entry]["username"] == user) {
            requests.push(log[entry]);
          }
        }
        return requests;
        // output:
        // [ reqObj1, reqObj2, reqObjN ]
      }
      function getUserRequestCount(log, user) {
        return getUserRequests(log, user).length;
        // output:
        // int
      }
      function getTotalRequestsPerUserSummary(log) {
        var requestsPerUserSummary = "";
        var requestsPerUser = getTotalRequestsPerUser(log);
        for (var user in requestsPerUser) {
          requestsPerUserSummary += `<br>${indent}` + requestsPerUser[user]["username"] + ": " + requestsPerUser[user]["totalRequests"];
        }
        return requestsPerUserSummary;
        // output:
        // usernameA: numA
        // usernameB: numB
        // usernameN: numN
      }
      function getMostActiveUsers(log, num) {
        var totalUsers = getTotalUsers(log)
        var usersRank = getTotalRequestsPerUser(log);
        var mostActiveUsers;
        if (num < totalUsers) {
          mostActiveUsers = usersRank.slice(0, num);
        } else {
          mostActiveUsers = usersRank;
        }
        return mostActiveUsers;
        // output:
        // [
        //   {
        //     username: "usernameA",
        //     totalRequests: int
        //   },
        //   ...
        // ]
      }
      function getMostActiveUsersSummary(log, num) {
        var mostActiveUsers = getMostActiveUsers(num);
        var mostActiveUsersSummary = "";
        for (var user in mostActiveUsers) {
          mostActiveUsersSummary += "<br>" + indent + mostActiveUsers[user]["username"] + ": " + mostActiveUsers[user]["totalRequests"];
        }
        return mostActiveUsersSummary;
        // output
        // usernameA: numA
        // usernameB: numB
        // usernameN: numN
      }
      function getUniqueRequests(log) {
        var requests = [];
        for (var entry in log) {
          var request = log[entry]["query"];
          if ( !requests.includes(request) ) {
            requests.push(request);
          }
        }
        return requests;
        // output:
        // [ "reqA", "reqB", "reqN" ]
      }
      function getRequestFrequency(log, request) {
        var requestFrequency = 0;
        for (var entry in log) {
          if ( request == log[entry]["query"] ) {
            requestFrequency++;
          }
        }
        return requestFrequency;
        // output:
        // int
      }
      function getRequestRank(log) {
        var requests = getUniqueRequests(log);
        var requestRank = [];
        for (var request in requests) {
          requestRank.push({ "request": requests[request], "frequency": getRequestFrequency(log, requests[request]) });
        }
        // sort requests by frequency
        requestRank.sort(function(a, b) {
          var keyA = new Date(a.frequency);
          var keyB = new Date(b.frequency);
          if (keyA < keyB) return 1;
          if (keyA > keyB) return -1;
          return 0;
        });
        return requestRank;
        // output:
        // [
        //   {
        //     request: "reqA",
        //     frequency: int
        //   },
        //   ...
        // ]
      }
      function getMostCommonRequests(log, num) {
        var requestRank = getRequestRank(log);
        var totalRequests = requestRank.length;
        var mostCommonRequests;
        if (num < totalRequests) {
          mostCommonRequests = requestRank.slice(0, num);
        } else {
          mostCommonRequests = requestRank;
        }
        return mostCommonRequests;
        // output:
        // [
        //   {
        //     request: "reqA",
        //     frequency: int
        //   },
        //   ...
        // ]
      }
      function getMostCommonRequestsSummary(log, num) {
        var requestRank = getMostCommonRequests(log, num);
        var mostCommonRequestsSummary = "";
        for (var request in requestRank) {
          mostCommonRequestsSummary += "<br>" + indent + requestRank[request]["request"] + ": " + requestRank[request]["frequency"];
        }
        return mostCommonRequestsSummary;
        // output
        // requestA: numA
        // requestB: numB
        // requestN: numN
      }
      function getAveRequestsPerDay(log) {
        var totalRequests = getTotalRequests(log);
        var timeStart = log[0]["timestamp"];
        var timeEnd = log[totalRequests - 1]["timestamp"];
        var timeDelta = timeEnd - timeStart;
        var days = timeDelta / 86400000;
        var aveRequestsPerDay = Math.round( (totalRequests / days) * 10 ) / 10;
        return aveRequestsPerDay;
        // output:
        // int
      }
      function getLogIntervalSlices(interval) {

      }
      function getReadableLog(log) {
        var readableLog = "";
        for (var entry in log) {
          readableLog += `
            <br>${indent} ${entry}. (${log[entry]["timestamp"]}) ${log[entry]["username"]} - ${log[entry]["query"]}`;
        }
        // output:
        // (timestampA) usernameA - queryA
        // (timestampB) usernameB - queryB
        // (timestampN) usernameN - queryN
        return readableLog;
          // log format
          //   [
          //     {
          //       uuid: string
          //       fname: string
          //       lname: string
          //       username: string
          //       query: string
          //       timestamp: epoch int
          //     },
          //     ...
          //   ]
      }
      function generateSummary(log) {
        var now = new Date(currentEpoch);
        var date = (now.getMonth() + 1) + "/" + now.getDate() + "/" + now.getFullYear();
        var totalRequests = getTotalRequests(log);
        var totalUsers = getTotalUsers(log);
        var aveRequestsPerUser = getAveRequestsPerUser(log);
        var totalRequestsPerUser = getTotalRequestsPerUserSummary(log);
        var mostActiveUsers = getMostActiveUsersSummary(log, 5);
        var mostCommonRequests = getMostCommonRequestsSummary(log, 10)
        var allRequests = getReadableLog(log);
        var aveRequestsPerDay = getAveRequestsPerDay(log);
        var summary = `
<strong>${date}</strong>
<br>Total Requests: ${totalRequests}
<br>Unique Users: ${totalUsers}
<br>Ave. Searches Per User: ${aveRequestsPerUser}
<br>Ave. Searches Per Day: ${aveRequestsPerDay}
<br>Total Searches Per User: ${totalRequestsPerUser}
<br>Most Common Requests: ${mostCommonRequests}
        `;
// <br><br>All Requests: ${allRequests}
// <br>Most Active Users: ${mostActiveUsers}
        // percent unique users in last week
        return summary;
      }


      function CopyToClipboard(containerid) {
        var e = document.getElementById(containerid);
        // for Internet Explorer
        if(document.body.createTextRange) {
          var range = document.body.createTextRange();
          range.moveToElementText(e);
          range.select();
          document.execCommand("Copy");
        }
        else if(window.getSelection) {
          // other browsers
          var selection = window.getSelection();
          var range = document.createRange();
          range.selectNodeContents(e);
          selection.removeAllRanges();
          selection.addRange(range);
          document.execCommand("Copy");
        }
      }
    </script>
  </body>
</html>
