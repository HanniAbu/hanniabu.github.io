<html>
  <head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1" name="viewport">
    <title>Log Viewer | Hanni Abu</title>
    <meta content="Easily view log contents." name="description">
    <meta content="log, file, view" name="keywords">
    <meta content="Hanni Abu" name="author">
    <meta content="Â© 2015, Hanni Abu. All rights reserved." name="copyright">
    <meta content="index,follow" name="robots">
    <link href="assets/img/logo.gif" rel="icon" type="image/gif">
    <link href="assets/css/style.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Lato:100,300,400,700,900" rel="stylesheet" type="text/css">
    <meta content="en_us">
    <meta content="Hanni Abu">
    <meta content="website">
    <meta content="index.html">
    <meta content="assets/img/logo.gif">
    <meta content="Easily view log contents.">
    <meta content="index.html" name="twitter:url">
    <meta content="Log Viewer | Hanni Abu" name="twitter:title">
    <meta content="Easily view log contents." name="twitter:description">
    <meta content="assets/img/logo.gif" name="twitter:image">
    
    <script async="" src="//www.google-analytics.com/analytics.js"></script><script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-63358219-1', 'auto'); ga('send', 'pageview'); 
    </script>

    <!-- CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

    <!-- jQuery and JS bundle w/ Popper.js -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
  </head>
  <body>
    <style type="text/css">
      body {
        width: 100vw;
        max-width: 500px;
        margin: 0 auto;
        margin-bottom: 40px;
        position: relative;
        padding: 20px;
      }
      input, input:focus, input:hover, input:active {
        /*remove style*/
        appearance: none !important;
        outline: none !important;
        outline: 0 !important;
        border-style: none !important;
        border-color: none !important;
        box-shadow: none !important;
        /*add style*/
        background-color: rgba(255,255,255,0.65);
        color: #555;
        text-align: center;
        border-radius: 5px;
        padding: 5px;
        font-size: .9em;
      }
      code {
        background-color: #eee;
        color: maroon;
        font-family: monospace;
      }
      textarea {
        overflow: auto;
        width: 100%
      }
      select {
        width: 150px;
        padding: 5px 10px;
      }
      p {
        font-weight: bold;
      }

    </style>


    <p>1. Select log file:</p>
    <input id="fileInput" type="file" name="file" />
    <p>2. Raw contents:
      <span onclick="CopyToClipboard('formatted')" title="copy" style="border: solid 1px #dfdfdf; padding: 5px 8px; border-radius:2px; background-color: #fff; float: right; cursor: pointer;">
        <span style="font-size: .875em; margin-right: .125em; position: relative; top: -.25em; left: -.125em">ðŸ“„<span style="position: absolute; top: .25em; left: .25em">ðŸ“„</span></span>
      </span>
    </p>
    <textarea id="raw" rows="2" cols="75"></textarea>
    <p>3. Summary:
      <span onclick="CopyToClipboard('summary')" title="copy" style="border: solid 1px #dfdfdf; padding: 5px 8px; border-radius:2px; background-color: #fff; float: right; cursor: pointer;">
        <span style="font-size: .875em; margin-right: .125em; position: relative; top: -.25em; left: -.125em">ðŸ“„<span style="position: absolute; top: .25em; left: .25em">ðŸ“„</span></span>
      </span>
    </p>
    <textarea id="summary" rows="15" cols="75"></textarea>



    <script type="text/javascript">
      window.addEventListener('load', function() {
        document.getElementById('fileInput').addEventListener('change', handleFileSelect, false);
      })
      var rawLog;
      var log;
      var currentEpoch = Date.now(); // milliseconds


      function handleFileSelect(event){
        const reader = new FileReader();
        reader.onload = handleFileLoad;
        reader.readAsText(event.target.files[0]);
      }
      function handleFileLoad(event){
        rawLog = event.target.result;
        document.getElementById('raw').textContent = rawLog;
        processData(rawLog);
      }
      function processData(rawLog) {
        var processedData = "[" + rawLog.split("}{").join("},{") + "]";
        log = JSON.parse(processedData);
        var summary = generateSummary();
        document.getElementById('summary').textContent = summary;
      }

      function getTotalRequests() {
        return log.length;
      }
      function getUniqueUsers() {
        var users = [];
        for (var entry in log) {
          var username = log[entry]["Username"];
          if ( !users.includes(username) ) {
            users.push(username);
          }
        }
        return users;
      }
      function getTotalUsers() {
        var users = getUniqueUsers();
        return users.length;
      }
      function getAveRequestsPerUser() {
        var totalRequests = getTotalRequests();
        var totalUsers = getTotalUsers();
        return Math.round( (totalRequests/totalUsers)*10 ) / 10;
      }
      function getTotalRequestsPerUser() {
        var users = getUniqueUsers();
        var requestsPerUser = [];
        for (var user in users) {
          requestsPerUser.push({ "username": users[user], "totalRequests": getUserRequestCount(users[user]) });
        }
        // sory user metrics my total requests
        requestsPerUser.sort(function(a, b) {
          var keyA = new Date(a.totalRequests);
          var keyB = new Date(b.totalRequests);
          if (keyA < keyB) return 1;
          if (keyA > keyB) return -1;
          return 0;
        });
        return requestsPerUser;
      }
      function getUserRequestCount(user) {
        var requestCount = 0;
        for (var entry in log) {
          if (log[entry]["Username"] == user) {
            requestCount++;
          }
        }
        return requestCount;
      }
      function getTotalRequestsPerUserSummary() {
        var requestsPerUserSummary = "";
        var requestsPerUser = getTotalRequestsPerUser();
        for (var user in requestsPerUser) {
          requestsPerUserSummary += "\n\t" + requestsPerUser[user]["username"] + ": " + requestsPerUser[user]["totalRequests"];
        }
        return requestsPerUserSummary;
      }
      function getMostActiveUsers(num) {
        var totalUsers = getTotalUsers()
        var usersRank = getTotalRequestsPerUser();
        var mostActiveUsers;
        if (num < totalUsers) {
          mostActiveUsers = usersRank.slice(0, num);
        } else {
          mostActiveUsers = usersRank;
        }
        return mostActiveUsers;
      }
      function getMostActiveUsersSummary(num) {
        var mostActiveUsers = getMostActiveUsers(num);
        var mostActiveUsersSummary = "";
        for (var user in mostActiveUsers) {
          // username (userRequestCount)
          // mostActiveUsersSummary += mostActiveUsers[user]["username"] + " (" + mostActiveUsers[user]["totalRequests"] + ")";
          // username: userRequestCount
          mostActiveUsersSummary += "\n\t" + mostActiveUsers[user]["username"] + ": " + mostActiveUsers[user]["totalRequests"];
        }
        return mostActiveUsersSummary; 
      }
      function generateSummary() {
        var totalRequests = getTotalRequests();
        var totalUsers = getTotalUsers();
        var aveRequestsPerUser = getAveRequestsPerUser();
        var totalRequestsPerUser = getTotalRequestsPerUserSummary();
        var mostActiveUsers = getMostActiveUsersSummary(5);
        var summary = `
Total Requests: ${totalRequests}
Unique Users: ${totalUsers}
Ave. Searches Per User: ${aveRequestsPerUser}
Total Searches Per User: ${totalRequestsPerUser}
Most Active Users: ${mostActiveUsers}
Requests Last Month: 
Requests Last Week: 
Requests This Month (Projected): 
Most Common Requests: 
Percent Active Last Week: 
        `;
        // percent unique users in last week
        return summary;
      }


      function CopyToClipboard(containerid) {
        var e = document.getElementById(containerid);
        // for Internet Explorer
        if(document.body.createTextRange) {
          var range = document.body.createTextRange();
          range.moveToElementText(e);
          range.select();
          document.execCommand("Copy");
        }
        else if(window.getSelection) {
          // other browsers
          var selection = window.getSelection();
          var range = document.createRange();
          range.selectNodeContents(e);
          selection.removeAllRanges();
          selection.addRange(range);
          document.execCommand("Copy");
        }
      }
    </script>
  </body>
</html>
